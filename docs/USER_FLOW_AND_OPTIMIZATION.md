# CatCat åŠŸèƒ½ç‚¹ä¸ç”¨æˆ·äº¤äº’æµç¨‹åˆ†æ

## ğŸ“‹ ç›®å½•
1. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
2. [ç”¨æˆ·è§’è‰²ä¸æƒé™](#ç”¨æˆ·è§’è‰²ä¸æƒé™)
3. [å®Œæ•´ç”¨æˆ·æ—…ç¨‹](#å®Œæ•´ç”¨æˆ·æ—…ç¨‹)
4. [æ­£å¸¸æµç¨‹](#æ­£å¸¸æµç¨‹)
5. [å¼‚å¸¸æµç¨‹](#å¼‚å¸¸æµç¨‹)
6. [ä»£ç é—®é¢˜åˆ†æ](#ä»£ç é—®é¢˜åˆ†æ)
7. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. ç”¨æˆ·ç®¡ç†æ¨¡å—
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| ç”¨æˆ·æ³¨å†Œ | âœ… | âš ï¸ ç¼ºå°‘æ‰‹æœºå·éªŒè¯ |
| ç”¨æˆ·ç™»å½• | âœ… | âœ… é”™è¯¯æç¤ºå®Œå–„ |
| JWTåˆ·æ–° | âœ… | âœ… Refresh Tokenæœºåˆ¶ |
| ç”¨æˆ·èµ„æ–™ | âœ… | âš ï¸ ç¼ºå°‘å¤´åƒä¸Šä¼  |
| é€€å‡ºç™»å½• | âœ… | âœ… Tokenå¤±æ•ˆ |

### 2. å® ç‰©ç®¡ç†æ¨¡å—
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| æ·»åŠ å® ç‰© | âœ… | âš ï¸ ç¼ºå°‘å¿…å¡«å­—æ®µéªŒè¯ |
| ç¼–è¾‘å® ç‰© | âœ… | âš ï¸ ç¼ºå°‘æ‰€æœ‰æƒéªŒè¯ |
| åˆ é™¤å® ç‰© | âœ… | âš ï¸ ç¼ºå°‘å…³è”è®¢å•æ£€æŸ¥ |
| å® ç‰©åˆ—è¡¨ | âœ… | âœ… ç©ºçŠ¶æ€å¤„ç† |

### 3. æœåŠ¡å¥—é¤æ¨¡å—
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| å¥—é¤åˆ—è¡¨ | âœ… | âœ… ç¼“å­˜ä¼˜åŒ– |
| å¥—é¤è¯¦æƒ… | âœ… | âœ… Bloom Filter |
| å¥—é¤æœç´¢ | âŒ | âŒ æœªå®ç° |

### 4. è®¢å•ç®¡ç†æ¨¡å—
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| åˆ›å»ºè®¢å• | âœ… | âš ï¸ æ—¶é—´å†²çªæ£€æŸ¥ç¼ºå¤± |
| è®¢å•é˜Ÿåˆ— | âœ… | âœ… NATS JetStream |
| è®¢å•åˆ—è¡¨ | âœ… | âœ… åˆ†é¡µ+ç­›é€‰ |
| è®¢å•è¯¦æƒ… | âœ… | âœ… å®Œå–„ |
| å–æ¶ˆè®¢å• | âœ… | âš ï¸ é€€æ¬¾é€»è¾‘ç¼ºå¤± |
| è®¢å•çŠ¶æ€å˜æ›´ | âœ… | âš ï¸ çŠ¶æ€æœºä¸å®Œæ•´ |

### 5. æœåŠ¡è¿›åº¦æ¨¡å—
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| è¿›åº¦åˆ›å»º | âœ… | âš ï¸ æƒé™éªŒè¯ä¸è¶³ |
| è¿›åº¦æŸ¥è¯¢ | âœ… | âœ… ç¼“å­˜ä¼˜åŒ– |
| å®æ—¶æ›´æ–° | âš ï¸ | âš ï¸ åº”æ”¹ä¸ºWebSocket |
| ç…§ç‰‡ä¸Šä¼  | âš ï¸ | âŒ æœªå®ç° |

### 6. è¯„ä»·ç³»ç»Ÿ
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| åˆ›å»ºè¯„ä»· | âœ… | âš ï¸ é‡å¤è¯„ä»·æ£€æŸ¥ |
| æœåŠ¡å‘˜å›å¤ | âœ… | âœ… æƒé™éªŒè¯ |
| è¯„ä»·åˆ—è¡¨ | âœ… | âœ… åˆ†é¡µ |

### 7. ç®¡ç†åå°
| åŠŸèƒ½ | çŠ¶æ€ | å¼‚å¸¸å¤„ç† |
|------|------|----------|
| ç”¨æˆ·ç®¡ç† | âœ… | âœ… å®Œå–„ |
| å® ç‰©ç®¡ç† | âœ… | âœ… å®Œå–„ |
| å¥—é¤ç®¡ç† | âœ… | âœ… å®Œå–„ |
| ç»Ÿè®¡æ•°æ® | âœ… | âœ… ç¼“å­˜ |

---

## ğŸ‘¥ ç”¨æˆ·è§’è‰²ä¸æƒé™

### è§’è‰²å®šä¹‰
```
Customer (1)        â†’ æ™®é€šç”¨æˆ·ï¼ˆå…»çŒ«äººï¼‰
ServiceProvider (2) â†’ æœåŠ¡æä¾›è€…ï¼ˆä¸Šé—¨æœåŠ¡å‘˜ï¼‰
Admin (99)          â†’ ç®¡ç†å‘˜
```

### æƒé™çŸ©é˜µ

| åŠŸèƒ½ | Customer | ServiceProvider | Admin |
|------|----------|-----------------|-------|
| æŸ¥çœ‹è‡ªå·±è®¢å• | âœ… | âœ… | âœ… |
| åˆ›å»ºè®¢å• | âœ… | âŒ | âœ… |
| æ¥å—è®¢å• | âŒ | âœ… | âŒ |
| æ›´æ–°æœåŠ¡è¿›åº¦ | âŒ | âœ… | âŒ |
| å–æ¶ˆè®¢å• | âœ… (é™åˆ¶æ¡ä»¶) | âœ… (é™åˆ¶æ¡ä»¶) | âœ… |
| è¯„ä»·æœåŠ¡ | âœ… | âŒ | âŒ |
| å›å¤è¯„ä»· | âŒ | âœ… | âŒ |
| ç®¡ç†ç”¨æˆ· | âŒ | âŒ | âœ… |
| ç®¡ç†å¥—é¤ | âŒ | âŒ | âœ… |

---

## ğŸš€ å®Œæ•´ç”¨æˆ·æ—…ç¨‹

### Cç«¯ç”¨æˆ·ï¼ˆCustomerï¼‰å®Œæ•´æ—…ç¨‹

```mermaid
graph TD
    A[è®¿é—®ç½‘ç«™] --> B{å·²ç™»å½•?}
    B -->|å¦| C[æ³¨å†Œ/ç™»å½•]
    B -->|æ˜¯| D[æµè§ˆé¦–é¡µ]
    C --> D
    D --> E{æœ‰å® ç‰©?}
    E -->|å¦| F[æ·»åŠ å® ç‰©ä¿¡æ¯]
    E -->|æ˜¯| G[æµè§ˆæœåŠ¡å¥—é¤]
    F --> G
    G --> H[é€‰æ‹©å¥—é¤]
    H --> I[åˆ›å»ºè®¢å•]
    I --> J{è®¢å•åˆ›å»ºæˆåŠŸ?}
    J -->|å¦| K[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    J -->|æ˜¯| L[è®¢å•è¿›å…¥é˜Ÿåˆ—]
    K --> G
    L --> M[ç­‰å¾…æœåŠ¡å‘˜æ¥å•]
    M --> N{æœ‰æœåŠ¡å‘˜æ¥å•?}
    N -->|å¦| O[è¶…æ—¶å–æ¶ˆ/é‡æ–°åˆ†é…]
    N -->|æ˜¯| P[æŸ¥çœ‹æœåŠ¡è¿›åº¦]
    O --> M
    P --> Q[æœåŠ¡è¿›è¡Œä¸­]
    Q --> R[æŸ¥çœ‹å®æ—¶æ›´æ–°]
    R --> S[æœåŠ¡å®Œæˆ]
    S --> T[ç¡®è®¤å¹¶è¯„ä»·]
    T --> U[å®Œæˆ]
```

### Bç«¯ç”¨æˆ·ï¼ˆServiceProviderï¼‰å®Œæ•´æ—…ç¨‹

```mermaid
graph TD
    A[ç™»å½•ç³»ç»Ÿ] --> B[æŸ¥çœ‹å¯æ¥è®¢å•]
    B --> C{æœ‰åˆé€‚è®¢å•?}
    C -->|å¦| D[ç­‰å¾…æ–°è®¢å•]
    C -->|æ˜¯| E[æŸ¥çœ‹è®¢å•è¯¦æƒ…]
    D --> B
    E --> F{å†³å®šæ¥å•?}
    F -->|å¦| B
    F -->|æ˜¯| G[æ¥å—è®¢å•]
    G --> H[æ›´æ–°çŠ¶æ€: On The Way]
    H --> I[å¯¼èˆªåˆ°æœåŠ¡åœ°ç‚¹]
    I --> J[æ›´æ–°çŠ¶æ€: Arrived]
    J --> K[å¼€å§‹æœåŠ¡]
    K --> L[æ›´æ–°æœåŠ¡è¿›åº¦]
    L --> M[ä¸Šä¼ æœåŠ¡ç…§ç‰‡]
    M --> N{æœåŠ¡å®Œæˆ?}
    N -->|å¦| L
    N -->|æ˜¯| O[æ›´æ–°çŠ¶æ€: Completed]
    O --> P[ç­‰å¾…ç”¨æˆ·ç¡®è®¤]
    P --> Q[æŸ¥çœ‹è¯„ä»·]
    Q --> R{éœ€è¦å›å¤?}
    R -->|æ˜¯| S[å›å¤è¯„ä»·]
    R -->|å¦| T[å®Œæˆ]
    S --> T
```

---

## âœ… æ­£å¸¸æµç¨‹è¯¦ç»†åˆ†æ

### 1. ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹

**æ­¥éª¤ï¼š**
1. ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç 
2. åç«¯éªŒè¯æ‰‹æœºå·æ ¼å¼
3. æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
4. å¯†ç å“ˆå¸Œå­˜å‚¨
5. ç”ŸæˆAccess Token + Refresh Token
6. è¿”å›JWT Token

**é—®é¢˜ç‚¹ï¼š**
- âš ï¸ **ç¼ºå°‘æ‰‹æœºå·éªŒè¯ç **
- âš ï¸ **ç¼ºå°‘å›¾å½¢éªŒè¯ç **
- âš ï¸ **å¯†ç å¼ºåº¦æ£€æŸ¥ä¸è¶³**

**ä¼˜åŒ–å»ºè®®ï¼š**
```csharp
// æ·»åŠ æ‰‹æœºå·éªŒè¯
public interface ISmsService
{
    Task<Result> SendVerificationCodeAsync(string phone);
    Task<Result<bool>> VerifyCodeAsync(string phone, string code);
}
```

---

### 2. åˆ›å»ºè®¢å•æµç¨‹

**å½“å‰æµç¨‹ï¼š**
```
ç”¨æˆ·é€‰æ‹©å¥—é¤ 
â†’ å¡«å†™æœåŠ¡ä¿¡æ¯ 
â†’ æäº¤è®¢å• 
â†’ è¿›å…¥NATSé˜Ÿåˆ— 
â†’ åå°å¤„ç† 
â†’ æ’å…¥æ•°æ®åº“
```

**é—®é¢˜ç‚¹ï¼š**
1. âš ï¸ **ç¼ºå°‘æ—¶é—´å†²çªæ£€æŸ¥**ï¼ˆåŒä¸€æœåŠ¡å‘˜åŒæ—¶æ®µè®¢å•ï¼‰
2. âš ï¸ **ç¼ºå°‘ä½™é¢æ£€æŸ¥**ï¼ˆé¢„ä»˜è´¹æ¨¡å¼ï¼‰
3. âš ï¸ **ç¼ºå°‘æœåŠ¡åŒºåŸŸæ£€æŸ¥**ï¼ˆæœåŠ¡å‘˜æœåŠ¡èŒƒå›´ï¼‰
4. âš ï¸ **ç¼ºå°‘è®¢å•é‡å¤æäº¤é˜²æŠ¤**

**ä¼˜åŒ–å»ºè®®ï¼š**
```csharp
public async Task<Result<long>> CreateOrderAsync(CreateOrderCommand command)
{
    // 1. æ£€æŸ¥å® ç‰©æ˜¯å¦å­˜åœ¨ä¸”å±äºè¯¥ç”¨æˆ·
    var pet = await petRepository.GetByIdAsync(command.PetId);
    if (pet == null || pet.UserId != command.UserId)
        return Result.Failure<long>("Pet not found or access denied");

    // 2. æ£€æŸ¥å¥—é¤æ˜¯å¦å¯ç”¨
    var package = await packageRepository.GetByIdAsync(command.PackageId);
    if (package == null || !package.IsActive)
        return Result.Failure<long>("Package not available");

    // 3. æ£€æŸ¥æ—¶é—´å†²çªï¼ˆåŒä¸€ç”¨æˆ·åŒæ—¶æ®µè®¢å•ï¼‰
    var hasConflict = await orderRepository.HasTimeConflictAsync(
        command.UserId, 
        command.ScheduledTime, 
        package.Duration);
    if (hasConflict)
        return Result.Failure<long>("Time conflict with existing order");

    // 4. æ£€æŸ¥ä½™é¢ï¼ˆå¦‚æœæ˜¯é¢„ä»˜è´¹ï¼‰
    if (requirePrepayment)
    {
        var balance = await userRepository.GetBalanceAsync(command.UserId);
        if (balance < package.Price)
            return Result.Failure<long>("Insufficient balance");
    }

    // 5. å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰
    var cacheKey = $"order:create:{command.UserId}:{command.PackageId}";
    var existingOrderId = await cache.GetAsync<long?>(cacheKey);
    if (existingOrderId.HasValue)
        return Result.Success(existingOrderId.Value);

    // 6. åˆ›å»ºè®¢å•å¹¶å‘é€åˆ°é˜Ÿåˆ—
    var message = new OrderQueueMessage(...);
    await natsConnection.PublishAsync("order.queue", message);

    // 7. ç¼“å­˜è®¢å•IDï¼ˆ5åˆ†é’Ÿå†…é˜²æ­¢é‡å¤æäº¤ï¼‰
    await cache.SetAsync(cacheKey, orderId, TimeSpan.FromMinutes(5));

    return Result.Success(orderId);
}
```

---

### 3. æœåŠ¡è¿›åº¦æ›´æ–°æµç¨‹

**å½“å‰æµç¨‹ï¼š**
```
æœåŠ¡å‘˜åˆ›å»ºè¿›åº¦æ›´æ–° 
â†’ æ’å…¥æ•°æ®åº“ 
â†’ æ¸…é™¤ç¼“å­˜ 
â†’ è¿”å›æˆåŠŸ
```

**é—®é¢˜ç‚¹ï¼š**
1. âš ï¸ **æƒé™éªŒè¯ä¸è¶³**ï¼ˆéœ€è¦ç¡®è®¤æ˜¯è¯¥è®¢å•çš„æœåŠ¡å‘˜ï¼‰
2. âš ï¸ **çŠ¶æ€é¡ºåºæ£€æŸ¥ç¼ºå¤±**ï¼ˆä¸èƒ½è·³è¿‡çŠ¶æ€ï¼‰
3. âš ï¸ **ç…§ç‰‡ä¸Šä¼ æœªå®ç°**
4. âš ï¸ **ç¼ºå°‘å®æ—¶æ¨é€**ï¼ˆåº”è¯¥ç”¨WebSocketï¼‰

**ä¼˜åŒ–å»ºè®®ï¼š**
```csharp
public async Task<Result<long>> CreateProgressAsync(CreateProgressCommand command)
{
    // 1. è·å–è®¢å•å¹¶éªŒè¯æƒé™
    var order = await orderRepository.GetByIdAsync(command.OrderId);
    if (order == null)
        return Result.Failure<long>("Order not found");

    if (order.ServiceProviderId != command.ServiceProviderId)
        return Result.Failure<long>("Access denied");

    // 2. éªŒè¯è®¢å•çŠ¶æ€ï¼ˆåªæœ‰Acceptedæˆ–InProgresså¯ä»¥æ›´æ–°è¿›åº¦ï¼‰
    if (order.Status != OrderStatus.Accepted && order.Status != OrderStatus.InProgress)
        return Result.Failure<long>("Order status invalid for progress update");

    // 3. éªŒè¯è¿›åº¦çŠ¶æ€é¡ºåºï¼ˆä¸èƒ½è·³è¿‡ï¼‰
    var latestProgress = await repository.GetLatestByOrderIdAsync(command.OrderId);
    if (latestProgress != null)
    {
        if (!IsValidStatusTransition(latestProgress.Status, command.Status))
            return Result.Failure<long>("Invalid status transition");
    }

    // 4. åˆ›å»ºè¿›åº¦è®°å½•
    var progress = new ServiceProgress { ... };
    var progressId = await repository.CreateAsync(progress);

    // 5. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (command.Status == ServiceProgressStatus.StartService && order.Status == OrderStatus.Accepted)
    {
        await orderRepository.UpdateStatusAsync(order.Id, OrderStatus.InProgress);
    }

    // 6. æ¸…é™¤ç¼“å­˜
    await cache.RemoveAsync($"progress:order:{command.OrderId}");

    // 7. å‘é€å®æ—¶é€šçŸ¥ï¼ˆWebSocketï¼‰
    await notificationHub.SendToUserAsync(
        order.CustomerId, 
        "ProgressUpdated", 
        new { orderId = order.Id, progress });

    // 8. å‘é€NATSäº‹ä»¶ï¼ˆç”¨äºå…¶ä»–æœåŠ¡æ¶ˆè´¹ï¼‰
    await natsConnection.PublishAsync("order.progress", 
        new OrderProgressEvent { OrderId = order.Id, Progress = progress });

    return Result.Success(progressId);
}

private bool IsValidStatusTransition(ServiceProgressStatus from, ServiceProgressStatus to)
{
    // å®šä¹‰å…è®¸çš„çŠ¶æ€è½¬æ¢
    var allowedTransitions = new Dictionary<ServiceProgressStatus, List<ServiceProgressStatus>>
    {
        [ServiceProgressStatus.OnTheWay] = new() { ServiceProgressStatus.Arrived },
        [ServiceProgressStatus.Arrived] = new() { ServiceProgressStatus.StartService },
        [ServiceProgressStatus.StartService] = new() { 
            ServiceProgressStatus.Feeding, 
            ServiceProgressStatus.CleaningLitter, 
            ServiceProgressStatus.Playing 
        },
        [ServiceProgressStatus.Feeding] = new() { 
            ServiceProgressStatus.CleaningLitter, 
            ServiceProgressStatus.Playing, 
            ServiceProgressStatus.Grooming,
            ServiceProgressStatus.Completed 
        },
        // ... å…¶ä»–çŠ¶æ€è½¬æ¢
    };

    return allowedTransitions.TryGetValue(from, out var allowed) && allowed.Contains(to);
}
```

---

## âŒ å¼‚å¸¸æµç¨‹åˆ†æ

### 1. è®¢å•åˆ›å»ºå¤±è´¥

**å¼‚å¸¸åœºæ™¯ï¼š**
| åœºæ™¯ | åŸå›  | å½“å‰å¤„ç† | å»ºè®®æ”¹è¿› |
|------|------|----------|----------|
| å® ç‰©ä¸å­˜åœ¨ | PetIdæ— æ•ˆ | âŒ æ•°æ®åº“é”™è¯¯ | âœ… è¿”å›å‹å¥½æç¤º |
| å¥—é¤ä¸å¯ç”¨ | PackageIdæ— æ•ˆ | âŒ æ•°æ®åº“é”™è¯¯ | âœ… è¿”å›å¥—é¤çŠ¶æ€ |
| æ—¶é—´å†²çª | åŒæ—¶æ®µå·²æœ‰è®¢å• | âŒ æœªæ£€æŸ¥ | âœ… æç¤ºå†²çªè®¢å• |
| ä½™é¢ä¸è¶³ | é¢„ä»˜è´¹ä½™é¢ä¸å¤Ÿ | âŒ æœªå®ç° | âœ… è¿”å›ä½™é¢ä¿¡æ¯ |
| æœåŠ¡åŒºåŸŸå¤– | åœ°å€ä¸åœ¨æœåŠ¡èŒƒå›´ | âŒ æœªæ£€æŸ¥ | âœ… æ˜¾ç¤ºæœåŠ¡åŒºåŸŸ |
| é‡å¤æäº¤ | ç”¨æˆ·å¤šæ¬¡ç‚¹å‡» | âŒ å¯èƒ½é‡å¤ | âœ… å¹‚ç­‰æ€§ä¿æŠ¤ |

---

### 2. è®¢å•å–æ¶ˆæµç¨‹

**å½“å‰é—®é¢˜ï¼š**
```csharp
// å½“å‰ä»£ç  - CancelOrderAsync
public async Task<Result> CancelOrderAsync(long orderId, string reason)
{
    var order = await repository.GetByIdAsync(orderId);
    if (order == null)
        return Result.Failure("Order not found");

    // âš ï¸ é—®é¢˜1: æ²¡æœ‰æ£€æŸ¥è®¢å•çŠ¶æ€ï¼ˆå·²å®Œæˆçš„ä¸èƒ½å–æ¶ˆï¼‰
    // âš ï¸ é—®é¢˜2: æ²¡æœ‰æ£€æŸ¥å–æ¶ˆæ—¶é™ï¼ˆæœåŠ¡å¼€å§‹åä¸èƒ½å–æ¶ˆï¼‰
    // âš ï¸ é—®é¢˜3: æ²¡æœ‰é€€æ¬¾é€»è¾‘
    // âš ï¸ é—®é¢˜4: æ²¡æœ‰é€šçŸ¥æœåŠ¡å‘˜

    order.Status = OrderStatus.Cancelled;
    await repository.UpdateAsync(order);

    return Result.Success();
}
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```csharp
public async Task<Result> CancelOrderAsync(long orderId, long userId, string reason)
{
    var order = await repository.GetByIdAsync(orderId);
    if (order == null)
        return Result.Failure("Order not found");

    // 1. æƒé™æ£€æŸ¥
    if (order.CustomerId != userId)
        return Result.Failure("Access denied");

    // 2. çŠ¶æ€æ£€æŸ¥
    if (order.Status == OrderStatus.Completed || order.Status == OrderStatus.Cancelled)
        return Result.Failure("Order cannot be cancelled");

    // 3. æ—¶é—´æ£€æŸ¥ï¼ˆæœåŠ¡å¼€å§‹å‰2å°æ—¶ä¸èƒ½å–æ¶ˆï¼‰
    var now = DateTime.UtcNow;
    var scheduledTime = DateTime.Parse(order.ScheduledTime);
    var hoursUntilService = (scheduledTime - now).TotalHours;

    if (hoursUntilService < 2 && order.Status != OrderStatus.Queued)
        return Result.Failure("Cannot cancel within 2 hours of service time");

    // 4. é€€æ¬¾å¤„ç†
    var refundResult = await paymentService.RefundAsync(order.Id);
    if (!refundResult.IsSuccess)
    {
        logger.LogError("Refund failed for order {OrderId}: {Error}", 
            orderId, refundResult.Error);
        // ç»§ç»­å–æ¶ˆï¼Œä½†è®°å½•é€€æ¬¾å¤±è´¥
    }

    // 5. æ›´æ–°è®¢å•çŠ¶æ€
    order.Status = OrderStatus.Cancelled;
    order.CancelReason = reason;
    order.CancelledAt = DateTime.UtcNow;
    await repository.UpdateAsync(order);

    // 6. é€šçŸ¥æœåŠ¡å‘˜ï¼ˆå¦‚æœå·²åˆ†é…ï¼‰
    if (order.ServiceProviderId.HasValue)
    {
        await notificationHub.SendToUserAsync(
            order.ServiceProviderId.Value,
            "OrderCancelled",
            new { orderId, reason });
    }

    // 7. å‘é€NATSäº‹ä»¶
    await natsConnection.PublishAsync("order.cancelled", 
        new OrderCancelledEvent { OrderId = orderId, Reason = reason });

    return Result.Success();
}
```

---

### 3. æœåŠ¡å‘˜æ— å“åº”

**åœºæ™¯ï¼š** è®¢å•åˆ›å»ºåï¼Œé•¿æ—¶é—´æ— æœåŠ¡å‘˜æ¥å•

**å½“å‰å¤„ç†ï¼š** âŒ æœªå¤„ç†

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```csharp
// åœ¨OrderProcessingServiceä¸­æ·»åŠ è¶…æ—¶æ£€æŸ¥
public class OrderProcessingService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // åŸæœ‰çš„é˜Ÿåˆ—å¤„ç†é€»è¾‘...

        // æ–°å¢ï¼šè¶…æ—¶æ£€æŸ¥ä»»åŠ¡
        _ = Task.Run(() => CheckOrderTimeoutsAsync(stoppingToken), stoppingToken);
    }

    private async Task CheckOrderTimeoutsAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                // æŸ¥è¯¢PendingçŠ¶æ€è¶…è¿‡30åˆ†é’Ÿçš„è®¢å•
                var timeoutOrders = await orderRepository
                    .GetPendingOrdersOlderThanAsync(TimeSpan.FromMinutes(30));

                foreach (var order in timeoutOrders)
                {
                    logger.LogWarning("Order {OrderId} timeout, reassigning...", order.Id);

                    // æ–¹æ¡ˆ1: è‡ªåŠ¨å–æ¶ˆå¹¶é€€æ¬¾
                    await orderService.CancelOrderAsync(order.Id, 
                        "Timeout: No service provider available");

                    // æ–¹æ¡ˆ2: æé«˜ä»·æ ¼é‡æ–°åˆ†é…
                    order.Price *= 1.2m; // ä»·æ ¼æå‡20%
                    order.Status = OrderStatus.Queued;
                    await orderRepository.UpdateAsync(order);

                    // é€šçŸ¥ç”¨æˆ·
                    await notificationHub.SendToUserAsync(
                        order.CustomerId,
                        "OrderReassigned",
                        new { orderId = order.Id, newPrice = order.Price });
                }

                await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Error checking order timeouts");
            }
        }
    }
}
```

---

### 4. æ”¯ä»˜å¤±è´¥å¤„ç†

**å½“å‰é—®é¢˜ï¼š** æ”¯ä»˜é€»è¾‘æœªå®Œå…¨å®ç°

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```csharp
public async Task<Result> ProcessPaymentAsync(long orderId)
{
    var order = await orderRepository.GetByIdAsync(orderId);
    if (order == null)
        return Result.Failure("Order not found");

    try
    {
        // 1. è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆStripeï¼‰
        var paymentResult = await stripeService.ChargeAsync(
            order.CustomerId,
            order.TotalPrice,
            order.OrderNo);

        if (!paymentResult.IsSuccess)
        {
            // 2. æ”¯ä»˜å¤±è´¥ - æ›´æ–°è®¢å•çŠ¶æ€
            order.PaymentStatus = "Failed";
            order.Status = OrderStatus.Cancelled;
            await orderRepository.UpdateAsync(order);

            // 3. è®°å½•æ”¯ä»˜æ—¥å¿—
            await paymentRepository.CreateAsync(new Payment
            {
                OrderId = orderId,
                Amount = order.TotalPrice,
                Status = "Failed",
                FailureReason = paymentResult.Error,
                CreatedAt = DateTime.UtcNow
            });

            // 4. é€šçŸ¥ç”¨æˆ·
            await notificationHub.SendToUserAsync(
                order.CustomerId,
                "PaymentFailed",
                new { orderId, reason = paymentResult.Error });

            return Result.Failure($"Payment failed: {paymentResult.Error}");
        }

        // 5. æ”¯ä»˜æˆåŠŸ - æ›´æ–°çŠ¶æ€
        order.PaymentStatus = "Paid";
        await orderRepository.UpdateAsync(order);

        await paymentRepository.CreateAsync(new Payment
        {
            OrderId = orderId,
            Amount = order.TotalPrice,
            Status = "Success",
            TransactionId = paymentResult.Value,
            CreatedAt = DateTime.UtcNow
        });

        return Result.Success();
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Payment processing error for order {OrderId}", orderId);
        return Result.Failure("Payment processing error");
    }
}
```

---

## ğŸ”§ ä»£ç é—®é¢˜æ€»ç»“ä¸ä¼˜åŒ–å»ºè®®

### é«˜ä¼˜å…ˆçº§é—®é¢˜

| é—®é¢˜ | ä½ç½® | é£é™©ç­‰çº§ | ä¿®å¤å»ºè®® |
|------|------|---------|----------|
| ç¼ºå°‘æƒé™éªŒè¯ | ServiceProgressEndpoints | ğŸ”´ é«˜ | æ·»åŠ è®¢å•æ‰€æœ‰æƒæ£€æŸ¥ |
| ç¼ºå°‘æ—¶é—´å†²çªæ£€æŸ¥ | OrderService.CreateOrder | ğŸ”´ é«˜ | å®ç°æ—¶é—´æ®µå†²çªæ£€æµ‹ |
| ç¼ºå°‘çŠ¶æ€æœºéªŒè¯ | OrderService | ğŸ”´ é«˜ | å®ç°è®¢å•çŠ¶æ€è½¬æ¢è§„åˆ™ |
| ç¼ºå°‘å¹‚ç­‰æ€§ä¿æŠ¤ | OrderService.CreateOrder | ğŸ”´ é«˜ | æ·»åŠ åˆ†å¸ƒå¼é”æˆ–ç¼“å­˜ |
| é€€æ¬¾é€»è¾‘æœªå®ç° | OrderService.CancelOrder | ğŸŸ¡ ä¸­ | å®ç°Stripeé€€æ¬¾ |
| ç…§ç‰‡ä¸Šä¼ æœªå®ç° | ServiceProgress | ğŸŸ¡ ä¸­ | é›†æˆOSS |
| ç¼ºå°‘æ‰‹æœºéªŒè¯ | AuthService | ğŸŸ¡ ä¸­ | é›†æˆçŸ­ä¿¡æœåŠ¡ |

### ä¸­ä¼˜å…ˆçº§é—®é¢˜

| é—®é¢˜ | ä½ç½® | é£é™©ç­‰çº§ | ä¿®å¤å»ºè®® |
|------|------|---------|----------|
| å®æ—¶é€šçŸ¥æœªå®ç° | å…¨å±€ | ğŸŸ¡ ä¸­ | æ·»åŠ SignalR |
| ç¼ºå°‘è®¢å•è¶…æ—¶å¤„ç† | OrderProcessingService | ğŸŸ¡ ä¸­ | æ·»åŠ å®šæ—¶æ£€æŸ¥ |
| ç¼ºå°‘ä½™é¢æ£€æŸ¥ | OrderService | ğŸŸ¡ ä¸­ | å®ç°é¢„ä»˜è´¹é€»è¾‘ |
| ç¼ºå°‘æœåŠ¡åŒºåŸŸæ£€æŸ¥ | OrderService | ğŸŸ¢ ä½ | å®ç°åœ°ç†å›´æ  |

---

## ğŸ“‹ ç«‹å³éœ€è¦å®æ–½çš„ä¼˜åŒ–æ¸…å•

### Phase 1: å®‰å…¨ä¸æƒé™ï¼ˆæœ¬æ¬¡å®æ–½ï¼‰
- [ ] æœåŠ¡è¿›åº¦æƒé™éªŒè¯
- [ ] è®¢å•çŠ¶æ€æœºå®Œå–„
- [ ] å¹‚ç­‰æ€§ä¿æŠ¤
- [ ] æ—¶é—´å†²çªæ£€æŸ¥

### Phase 2: ä¸šåŠ¡æµç¨‹ï¼ˆä¸‹ä¸€æ­¥ï¼‰
- [ ] é€€æ¬¾é€»è¾‘å®ç°
- [ ] è®¢å•è¶…æ—¶å¤„ç†
- [ ] ä½™é¢æ£€æŸ¥
- [ ] æ”¯ä»˜æµç¨‹å®Œå–„

### Phase 3: ç”¨æˆ·ä½“éªŒï¼ˆåç»­ï¼‰
- [ ] WebSocketå®æ—¶é€šçŸ¥
- [ ] ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½
- [ ] æ‰‹æœºå·éªŒè¯
- [ ] æœåŠ¡åŒºåŸŸæ£€æŸ¥

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š** ç«‹å³å¼€å§‹Phase 1çš„ä»£ç ä¼˜åŒ–å®æ–½ã€‚

*Last Updated: 2025-10-03*

