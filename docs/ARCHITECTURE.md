# CatCat 架构设计文档

## 系统架构

### 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                        用户端                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 手机App  │  │ 平板App  │  │ PC网页   │              │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘              │
└────────┼─────────────┼─────────────┼────────────────────┘
         │             │             │
         └─────────────┴─────────────┘
                       │
         ┌─────────────▼──────────────┐
         │     Nginx (负载均衡)        │
         └─────────────┬──────────────┘
                       │
         ┌─────────────▼──────────────┐
         │      API Gateway            │
         │  (认证/限流/路由)            │
         └─────────────┬──────────────┘
                       │
         ┌─────────────▼──────────────┐
         │   ASP.NET Core 9 API       │
         │   (支持AOT, 多实例集群)     │
         └──┬─────┬─────┬──────┬──────┘
            │     │     │      │
    ┌───────┘     │     │      └──────┐
    │             │     │             │
    ▼             ▼     ▼             ▼
┌────────┐  ┌─────────┐ ┌─────┐  ┌────────┐
│PostgreSQL│ │  Redis  │ │NATS │  │对象存储 │
│ (主库)  │  │ (缓存)  │ │(MQ) │  │(图片)  │
└────────┘  └─────────┘ └─────┘  └────────┘
```

### 技术栈选型

#### 后端
- **框架**: ASP.NET Core 9 (Minimal API)
  - 使用Minimal API架构，更轻量简洁
  - 原生支持AOT编译，启动速度快
  - 高性能异步处理
  - 跨平台运行
  - 更好的性能和更小的内存占用

- **ORM**: Sqlx
  - 基于Source Generator，编译时代码生成
  - 占位符语法，自动生成SQL
  - 完美支持Native AOT编译
  - 零运行时反射，性能极致
  - 无状态设计，完美支持集群部署

  详细说明：[Sqlx 架构设计文档](./SQLX_ARCHITECTURE.md)

- **数据库**: PostgreSQL 15
  - 开源稳定，功能强大
  - 支持JSON、数组等复杂类型
  - 性能优异，适合生产环境

- **缓存**: Redis 7
  - 高性能键值存储
  - 支持多种数据结构
  - 用于会话、验证码、热点数据缓存

- **消息队列**: NATS
  - 轻量级，性能卓越
  - 支持发布订阅、请求响应
  - 用于异步任务、事件通知

#### 前端
- **框架**: Vue 3 + TypeScript
  - 组合式API，代码更简洁
  - 完整的TypeScript类型支持
  - 类型安全，开发体验好
  - 生态成熟

- **路由**: Vue Router 4
  - 官方路由方案
  - 支持路由守卫、懒加载

- **状态管理**: Pinia
  - Vue 3推荐方案
  - 轻量级，API简洁
  - TypeScript支持好

- **UI组件**: Vant 4
  - 移动端UI组件库
  - 响应式设计
  - 支持按需引入

### 核心功能模块

#### 1. 用户认证模块
- **功能**:
  - 手机号注册登录
  - 短信验证码
  - JWT Token认证
  - 角色权限控制（客户/服务人员/管理员）

- **安全措施**:
  - 密码加盐哈希存储
  - Token过期刷新机制
  - API限流保护
  - 敏感操作二次验证

#### 2. 服务人员管理模块
- **功能**:
  - 实名认证（身份证验证）
  - 资质证书上传审核
  - 背景调查记录
  - 服务评分系统
  - 接单能力管理

- **信任机制**:
  - 三级审核流程
  - 用户评价体系
  - 服务质量监控
  - 投诉处理机制

#### 3. 订单管理模块
- **功能**:
  - 预约下单
  - 智能派单（距离、评分、空闲时间）
  - 订单状态追踪
  - 服务过程监控
  - 评价反馈

- **状态流转**:
  ```
  待接单 → 已接单 → 服务中 → 已完成 → 已评价
                      ↓
                   已取消/已退款
  ```

#### 4. 实时通信模块
- **功能**:
  - 订单状态实时推送（NATS）
  - 服务人员位置追踪
  - 即时消息通知
  - 图片/视频实时上传

- **技术实现**:
  - WebSocket长连接
  - NATS消息订阅
  - Server-Sent Events

#### 5. 文件存储模块
- **功能**:
  - 图片上传（头像、证件、服务照片）
  - 视频上传（服务视频）
  - 文件压缩优化
  - CDN加速分发

- **存储方案**:
  - 对象存储（阿里云OSS/腾讯云COS）
  - 本地文件系统（开发环境）
  - 图片自动压缩、生成缩略图

### 数据库设计

#### 核心表结构
1. **users** - 用户表
2. **service_providers** - 服务人员信息表
3. **pets** - 宠物信息表
4. **service_packages** - 服务套餐表
5. **service_orders** - 服务订单表
6. **service_records** - 服务记录（照片/视频）表
7. **reviews** - 评价表

详见: `database/init.sql`

### 部署架构

#### 单机部署
```
Docker Compose
├── PostgreSQL
├── Redis
├── NATS
├── API (1实例)
└── Web (Nginx)
```

#### 集群部署
```
Kubernetes Cluster
├── API Pods (3-10个副本, HPA自动扩缩容)
├── Web Pods (2-5个副本)
├── PostgreSQL (主从复制)
├── Redis (哨兵模式/集群模式)
└── NATS (集群模式)
```

### CI/CD流程

```
Developer Push
      ↓
GitHub Actions触发
      ↓
┌─────┴─────┐
│  构建测试  │
├───────────┤
│ Backend   │ ← dotnet build/test
│ Frontend  │ ← npm build
└─────┬─────┘
      ↓
┌─────┴─────┐
│ Docker构建 │
├───────────┤
│ API镜像   │
│ Web镜像   │
└─────┬─────┘
      ↓
推送到Registry
      ↓
自动部署到K8s
```

### 性能优化

1. **数据库优化**
   - 合理使用索引
   - 查询语句优化
   - 读写分离
   - 连接池管理

2. **缓存策略**
   - 热点数据Redis缓存
   - 用户会话缓存
   - 服务套餐缓存
   - 缓存预热和更新

3. **API优化**
   - AOT编译减少启动时间
   - 异步处理提升吞吐
   - 响应压缩
   - 分页查询

4. **前端优化**
   - 组件懒加载
   - 图片懒加载
   - 路由懒加载
   - PWA离线支持

### 安全设计

1. **数据安全**
   - 敏感数据加密存储
   - HTTPS传输
   - SQL注入防护
   - XSS防护

2. **认证授权**
   - JWT Token认证
   - 基于角色的权限控制(RBAC)
   - API访问控制

3. **业务安全**
   - 实名认证
   - 服务保证金
   - 行为审计日志
   - 风险监控预警

### 监控告警

1. **应用监控**
   - 健康检查端点
   - 性能指标收集
   - 错误日志聚合

2. **基础设施监控**
   - CPU、内存、磁盘监控
   - 数据库连接数监控
   - Redis性能监控

3. **业务监控**
   - 订单量统计
   - 用户活跃度
   - 服务质量指标
   - 异常订单告警

## 扩展性

系统设计支持：
- 水平扩展（增加API实例）
- 数据库分库分表
- 微服务拆分
- 多地域部署
- 第三方服务接入（支付、地图、短信等）

